name: Deploy

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify Pages Project
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "éªŒè¯ Pages é¡¹ç›®æ˜¯å¦å­˜åœ¨: ${{ secrets.PROJECT_NAME }}"
          pnpm dlx wrangler@latest pages project list
          pnpm dlx wrangler@latest pages project view ${{ secrets.PROJECT_NAME }} || echo "é¡¹ç›®ä¸å­˜åœ¨ï¼Œå°†åœ¨éƒ¨ç½²é˜¶æ®µåˆ›å»º"

      - name: Run deploy with retries
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
          # å…¶ä»–ç¯å¢ƒå˜é‡...
        run: |
          # ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆ Wrangler
          npm install --save-dev wrangler@latest
          
          # é‡è¯•é€»è¾‘
          max_retries=3
          attempt=1
          while [ $attempt -le $max_retries ]; do
            echo "âŒ› å°è¯•éƒ¨ç½² (ç¬¬ $attempt æ¬¡/$max_retries)"
            
            # å…ˆéªŒè¯/åˆ›å»ºé¡¹ç›®
            if ! pnpm dlx wrangler pages project view $PROJECT_NAME; then
              echo "ğŸ†• åˆ›å»º Pages é¡¹ç›®..."
              pnpm dlx wrangler pages project create $PROJECT_NAME --production-branch=main
            fi
            
            # æ‰§è¡Œéƒ¨ç½²
            if pnpm dlx tsx scripts/deploy/index.ts; then
              echo "âœ… éƒ¨ç½²æˆåŠŸ"
              exit 0
            else
              echo "âš ï¸ éƒ¨ç½²å¤±è´¥ï¼Œç­‰å¾… 10 ç§’åé‡è¯•..."
              sleep 10
              ((attempt++))
            fi
          done
          
          echo "âŒ å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œéƒ¨ç½²å¤±è´¥"
          exit 1

      - name: Debug on failure
        if: failure()
        run: |
          echo "=== è°ƒè¯•ä¿¡æ¯ ==="
          echo "PROJECT_NAME: ${{ secrets.PROJECT_NAME }}"
          echo "CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          echo "Wrangler ç‰ˆæœ¬: $(pnpm dlx wrangler --version)"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç¯å¢ƒæ–‡ä»¶å†…å®¹:"
          cat .env.runtime || echo "æ— .env.runtimeæ–‡ä»¶"
          echo "Wrangler æ—¥å¿—:"
          cat ~/.config/.wrangler/logs/wrangler-*.log || echo "æ— Wrangleræ—¥å¿—"

      - name: Cleanup
        run: |
          rm -f .env*.*
          rm -f wrangler*.json
