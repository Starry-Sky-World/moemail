name: Deploy

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup environment
        run: |
          # 安装最新版 Wrangler 避免版本问题
          npm install --no-save wrangler@latest
          echo "CLOUDFLARE_API_TOKEN 长度: ${#CLOUDFLARE_API_TOKEN}"
          echo "PROJECT_NAME: $PROJECT_NAME"

      - name: Cleanup Domains
        run: |
          # 获取项目关联的自定义域名并逐个删除
          domains=$(npx wrangler pages project list-domains $PROJECT_NAME --json | jq -r '.[].name')
          for domain in $domains; do
            echo "删除域名: $domain"
            npx wrangler pages project delete-domain $PROJECT_NAME $domain || true
            sleep 3
          done

      - name: Delete Existing Project
        run: |
          npx wrangler pages project delete $PROJECT_NAME || true
          sleep 5

      - name: Create New Project
        run: |
          npx wrangler pages project create $PROJECT_NAME \
            --production-branch=main \
            --compatibility-flags=nodejs_compat

      - name: Deploy Application
        run: |
          max_retries=3
          attempt=1
          while [ $attempt -le $max_retries ]; do
            if pnpm run deploy:pages; then
              exit 0
            fi
            echo "⚠️ Attempt $attempt failed, retrying in 15 seconds..."
            sleep 15
            ((attempt++))
          done
          exit 1

      - name: Verify Deployment
        run: |
          echo "部署验证:"
          npx wrangler pages deployment list --project-name=$PROJECT_NAME
