name: Deploy

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: |
          pnpm install --frozen-lockfile
          npm install --no-save wrangler@latest

      - name: Prepare Project
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
        run: |
          # Ê∏ÖÁêÜÂèØËÉΩÁöÑÂÜ≤Á™ÅÈ°πÁõÆ
          npx wrangler pages project delete $PROJECT_NAME || true
          sleep 5
          
          # ÂàõÂª∫Êñ∞È°πÁõÆ
          npx wrangler pages project create $PROJECT_NAME --production-branch=main
          sleep 3

      - name: Run Deployment
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
        run: |
          max_retries=3
          attempt=1
          
          while [ $attempt -le $max_retries ]; do
            echo "‚åõ Attempt $attempt/$max_retries"
            
            # È™åËØÅÈ°πÁõÆÁä∂ÊÄÅ
            if npx wrangler pages project list | grep -q "$PROJECT_NAME"; then
              echo "‚úÖ Project verified"
              if pnpm run deploy:pages; then
                echo "üöÄ Deployment successful"
                exit 0
              fi
            fi
            
            echo "‚ö†Ô∏è Retrying in 15 seconds..."
            sleep 15
            ((attempt++))
          done
          
          echo "‚ùå All attempts failed"
          exit 1

      - name: Debug on Failure
        if: failure()
        run: |
          echo "=== DEBUG INFO ==="
          echo "Project Name: ${{ secrets.PROJECT_NAME }}"
          echo "Account ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          echo "Wrangler Version: $(npx wrangler --version)"
          echo "Current Projects:"
          npx wrangler pages project list
          echo "Logs:"
          cat ~/.config/.wrangler/logs/wrangler-*.log || echo "No logs found"

      - name: Cleanup
        run: |
          rm -f .env*.*
          rm -f wrangler*.json
