name: Deploy

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: |
          pnpm install --frozen-lockfile
          # å•ç‹¬å®‰è£…æœ€æ–°ç‰ˆ Wrangler é¿å…å†²çª
          npm install --no-save wrangler@latest

      - name: Verify Pages Project
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "éªŒè¯ Pages é¡¹ç›®çŠ¶æ€..."
          npx wrangler pages project list | grep "${{ secrets.PROJECT_NAME }}" || echo "é¡¹ç›®ä¸å­˜åœ¨"

      - name: Run deploy with retries
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
          # å…¶ä»–ç¯å¢ƒå˜é‡...
        run: |
          max_retries=3
          attempt=1
          
          while [ $attempt -le $max_retries ]; do
            echo "âŒ› å°è¯•éƒ¨ç½² (ç¬¬ $attempt æ¬¡/$max_retries)"
            
            # ä½¿ç”¨ npx ç¡®ä¿è°ƒç”¨çš„æ˜¯æœ€æ–°å®‰è£…çš„ wrangler
            if npx wrangler pages project list | grep -q "$PROJECT_NAME"; then
              echo "âœ… é¡¹ç›®å·²å­˜åœ¨"
            else
              echo "ğŸ†• åˆ›å»º Pages é¡¹ç›®..."
              npx wrangler pages project create "$PROJECT_NAME" --production-branch=main || true
            fi
            
            # æ‰§è¡Œéƒ¨ç½²
            if pnpm dlx tsx scripts/deploy/index.ts; then
              echo "âœ… éƒ¨ç½²æˆåŠŸ"
              exit 0
            else
              echo "âš ï¸ éƒ¨ç½²å¤±è´¥ï¼Œç­‰å¾… 15 ç§’åé‡è¯•..."
              sleep 15
              ((attempt++))
            fi
          done
          
          echo "âŒ å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œéƒ¨ç½²å¤±è´¥"
          exit 1

      - name: Debug on failure
        if: failure()
        run: |
          echo "=== è°ƒè¯•ä¿¡æ¯ ==="
          echo "PROJECT_NAME: ${{ secrets.PROJECT_NAME }}"
          echo "CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          echo "Wrangler ç‰ˆæœ¬: $(npx wrangler --version)"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç¯å¢ƒæ–‡ä»¶å†…å®¹:"
          cat .env.runtime || echo "æ— .env.runtimeæ–‡ä»¶"
          echo "Wrangler æ—¥å¿—:"
          cat ~/.config/.wrangler/logs/wrangler-*.log || echo "æ— Wrangleræ—¥å¿—"

      - name: Cleanup
        run: |
          rm -f .env*.*
          rm -f wrangler*.json
